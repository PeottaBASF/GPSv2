<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste do Sistema - Gerenciamento de Rotas</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Azure Maps CSS -->
    <link rel="stylesheet" href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.css" type="text/css">

    <!-- Estilos personalizados -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header class="bg-dark text-white py-3">
        <div class="container">
            <h1>üîß Teste do Sistema de Rotas</h1>
            <p class="mb-0">Valida√ß√£o de configura√ß√£o e funcionalidades</p>
        </div>
    </header>

    <main class="container my-4">
        <!-- Status Geral -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h3>üìä Status Geral do Sistema</h3>
                    </div>
                    <div class="card-body">
                        <div id="overall-status" class="alert alert-info">
                            üîÑ Executando testes...
                        </div>
                        <div class="progress mb-3">
                            <div class="progress-bar" id="test-progress" role="progressbar" style="width: 0%">0%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Testes das Bibliotecas -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-info text-white">
                        <h4>üìö Bibliotecas JavaScript</h4>
                    </div>
                    <div class="card-body">
                        <p>Verifica se as bibliotecas JavaScript foram carregadas</p>
                        <div id="library-tests">
                            <div class="test-item" id="test-qrcode">
                                <strong>QRCode.js:</strong> <span class="status">Testando...</span>
                            </div>
                            <div class="test-item" id="test-azure">
                                <strong>Azure Maps SDK:</strong> <span class="status">Testando...</span>
                            </div>
                            <div class="test-item" id="test-bootstrap">
                                <strong>Bootstrap:</strong> <span class="status">Testando...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-warning text-dark">
                        <h4>‚öôÔ∏è Configura√ß√£o do Sistema</h4>
                    </div>
                    <div class="card-body">
                        <p>Verifica configura√ß√µes do arquivo config.js</p>
                        <div id="config-tests">
                            <div class="test-item" id="test-azure-key">
                                <strong>Chave Azure Maps:</strong> <span class="status">Testando...</span>
                            </div>
                            <div class="test-item" id="test-portarias">
                                <strong>Portarias Configuradas:</strong> <span class="status">Testando...</span>
                            </div>
                            <div class="test-item" id="test-docas">
                                <strong>Docas Configuradas:</strong> <span class="status">Testando...</span>
                            </div>
                            <div class="test-item" id="test-coordinates">
                                <strong>Coordenadas V√°lidas:</strong> <span class="status">Testando...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Teste de Conectividade -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h4>üåê Conectividade e APIs</h4>
                    </div>
                    <div class="card-body">
                        <div id="connectivity-tests">
                            <div class="test-item" id="test-internet">
                                <strong>Conex√£o com Internet:</strong> <span class="status">Testando...</span>
                            </div>
                            <div class="test-item" id="test-azure-api">
                                <strong>API do Azure Maps:</strong> <span class="status">Testando...</span>
                            </div>
                            <div class="test-item" id="test-cdn">
                                <strong>Acesso aos CDNs:</strong> <span class="status">Testando...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Teste Funcional -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h4>üß™ Teste Funcional</h4>
                    </div>
                    <div class="card-body">
                        <p>Simula opera√ß√µes do sistema</p>
                        <div class="mb-3">
                            <button class="btn btn-primary me-2" id="test-qr-generation">
                                üéØ Testar Gera√ß√£o de QR Code
                            </button>
                            <button class="btn btn-secondary me-2" id="test-route-calculation">
                                üó∫Ô∏è Testar C√°lculo de Rota
                            </button>
                            <button class="btn btn-info" id="test-validation">
                                ‚úÖ Testar Valida√ß√µes
                            </button>
                        </div>
                        <div id="functional-tests">
                            <div class="test-item" id="test-data-encoding">
                                <strong>Codifica√ß√£o de Dados:</strong> <span class="status">Aguardando teste</span>
                            </div>
                            <div class="test-item" id="test-map-loading">
                                <strong>Carregamento do Mapa:</strong> <span class="status">Aguardando teste</span>
                            </div>
                            <div class="test-item" id="test-form-validation">
                                <strong>Valida√ß√£o de Formul√°rios:</strong> <span class="status">Aguardando teste</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Relat√≥rio Detalhado -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <h4>üìã Relat√≥rio Detalhado</h4>
                    </div>
                    <div class="card-body">
                        <div id="detailed-report" class="code-block">
                            Executando testes do sistema...
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-outline-primary" id="download-report">
                                üíæ Baixar Relat√≥rio
                            </button>
                            <button class="btn btn-outline-secondary" id="rerun-tests">
                                üîÑ Executar Testes Novamente
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-dark text-white py-3 mt-5">
        <div class="container text-center">
            <p class="mb-0">&copy; 2025 Sistema de Teste - Gerenciamento de Rotas</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs@master/qrcode.min.js"></script>
    <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>

    <script>
        // Sistema de testes autom√°tico
        class SystemTester {
            constructor() {
                this.results = {};
                this.testCount = 0;
                this.completedTests = 0;
                this.startTime = Date.now();
            }

            async runAllTests() {
                await this.testLibraries();
                await this.testConfiguration();
                await this.testConnectivity();
                this.generateReport();
            }

            async testLibraries() {
                this.updateProgress(10);

                // Teste QRCode.js
                const qrcodeResult = typeof QRCode !== 'undefined';
                this.updateTestResult('test-qrcode', qrcodeResult, 
                    qrcodeResult ? '‚úÖ Carregado' : '‚ùå N√£o carregado');

                // Teste Azure Maps
                const azureResult = typeof atlas !== 'undefined';
                this.updateTestResult('test-azure', azureResult, 
                    azureResult ? '‚úÖ Carregado' : '‚ùå N√£o carregado');

                // Teste Bootstrap
                const bootstrapResult = typeof bootstrap !== 'undefined';
                this.updateTestResult('test-bootstrap', bootstrapResult, 
                    bootstrapResult ? '‚úÖ Carregado' : '‚ùå N√£o carregado');

                this.updateProgress(30);
            }

            async testConfiguration() {
                this.updateProgress(40);

                // Teste chave Azure Maps
                const azureKeyValid = AZURE_MAPS_CONFIG.subscriptionKey && 
                    AZURE_MAPS_CONFIG.subscriptionKey !== 'SUA_CHAVE_AZURE_MAPS_AQUI' &&
                    AZURE_MAPS_CONFIG.subscriptionKey.length > 20;
                this.updateTestResult('test-azure-key', azureKeyValid, 
                    azureKeyValid ? '‚úÖ Configurada' : '‚ö†Ô∏è N√£o configurada');

                // Teste portarias
                const portariasValid = PORTARIAS && PORTARIAS.length > 0;
                this.updateTestResult('test-portarias', portariasValid, 
                    portariasValid ? `‚úÖ ${PORTARIAS.length} configuradas` : '‚ùå Nenhuma configurada');

                // Teste docas
                const docasValid = DOCAS && DOCAS.length > 0;
                this.updateTestResult('test-docas', docasValid, 
                    docasValid ? `‚úÖ ${DOCAS.length} configuradas` : '‚ùå Nenhuma configurada');

                // Teste coordenadas
                let coordenadasValidas = 0;
                let totalCoordenadas = 0;

                [...PORTARIAS, ...DOCAS].forEach(item => {
                    totalCoordenadas++;
                    if (item.coordenadas && 
                        typeof item.coordenadas.latitude === 'number' &&
                        typeof item.coordenadas.longitude === 'number' &&
                        item.coordenadas.latitude !== null &&
                        item.coordenadas.longitude !== null) {
                        coordenadasValidas++;
                    }
                });

                const coordsResult = coordenadasValidas === totalCoordenadas;
                this.updateTestResult('test-coordinates', coordsResult, 
                    coordsResult ? `‚úÖ ${coordenadasValidas}/${totalCoordenadas} v√°lidas` : 
                    `‚ö†Ô∏è ${coordenadasValidas}/${totalCoordenadas} v√°lidas`);

                this.updateProgress(60);
            }

            async testConnectivity() {
                this.updateProgress(70);

                // Teste internet
                try {
                    await fetch('https://www.google.com/favicon.ico', { method: 'HEAD', mode: 'no-cors' });
                    this.updateTestResult('test-internet', true, '‚úÖ Conectado');
                } catch {
                    this.updateTestResult('test-internet', false, '‚ùå Sem conex√£o');
                }

                // Teste Azure API
                if (AZURE_MAPS_CONFIG.subscriptionKey && 
                    AZURE_MAPS_CONFIG.subscriptionKey !== 'SUA_CHAVE_AZURE_MAPS_AQUI') {
                    try {
                        const response = await fetch(
                            `https://atlas.microsoft.com/search/address/json?api-version=1.0&subscription-key=${AZURE_MAPS_CONFIG.subscriptionKey}&query=S√£o Paulo`
                        );
                        const azureApiResult = response.ok;
                        this.updateTestResult('test-azure-api', azureApiResult, 
                            azureApiResult ? '‚úÖ API funcionando' : '‚ùå Erro na API');
                    } catch {
                        this.updateTestResult('test-azure-api', false, '‚ùå Erro de conex√£o');
                    }
                } else {
                    this.updateTestResult('test-azure-api', false, '‚ö†Ô∏è Chave n√£o configurada');
                }

                // Teste CDNs
                try {
                    const cdnTests = await Promise.all([
                        fetch('https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs@master/qrcode.min.js', { method: 'HEAD' }),
                        fetch('https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.js', { method: 'HEAD' }),
                        fetch('https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js', { method: 'HEAD' })
                    ]);

                    const cdnResult = cdnTests.every(response => response.ok);
                    this.updateTestResult('test-cdn', cdnResult, 
                        cdnResult ? '‚úÖ Todos acess√≠veis' : '‚ö†Ô∏è Alguns inacess√≠veis');
                } catch {
                    this.updateTestResult('test-cdn', false, '‚ùå Erro de acesso');
                }

                this.updateProgress(90);
            }

            updateTestResult(testId, success, message) {
                const element = document.getElementById(testId);
                const statusElement = element.querySelector('.status');
                statusElement.textContent = message;

                element.classList.remove('test-pass', 'test-fail', 'test-warn');
                if (success) {
                    element.classList.add('test-pass');
                } else if (message.includes('‚ö†Ô∏è')) {
                    element.classList.add('test-warn');
                } else {
                    element.classList.add('test-fail');
                }

                this.results[testId] = { success, message };
            }

            updateProgress(percentage) {
                const progressBar = document.getElementById('test-progress');
                progressBar.style.width = percentage + '%';
                progressBar.textContent = percentage + '%';
            }

            generateReport() {
                this.updateProgress(100);

                const totalTests = Object.keys(this.results).length;
                const passedTests = Object.values(this.results).filter(r => r.success).length;
                const warningTests = Object.values(this.results).filter(r => r.message.includes('‚ö†Ô∏è')).length;
                const failedTests = totalTests - passedTests - warningTests;

                const overallStatus = document.getElementById('overall-status');
                const executionTime = ((Date.now() - this.startTime) / 1000).toFixed(2);

                if (failedTests === 0 && warningTests === 0) {
                    overallStatus.className = 'alert alert-success';
                    overallStatus.innerHTML = `‚úÖ Sistema totalmente funcional! (${executionTime}s)`;
                } else if (failedTests === 0) {
                    overallStatus.className = 'alert alert-warning';
                    overallStatus.innerHTML = `‚ö†Ô∏è Sistema funcional com avisos (${executionTime}s)`;
                } else {
                    overallStatus.className = 'alert alert-danger';
                    overallStatus.innerHTML = `‚ùå Sistema com problemas cr√≠ticos (${executionTime}s)`;
                }

                // Relat√≥rio detalhado
                const detailedReport = document.getElementById('detailed-report');
                let report = `RELAT√ìRIO DE TESTE DO SISTEMA\n`;
                report += `========================================\n`;
                report += `Data/Hora: ${new Date().toLocaleString('pt-BR')}\n`;
                report += `Tempo de execu√ß√£o: ${executionTime}s\n`;
                report += `\n`;
                report += `RESUMO:\n`;
                report += `‚úÖ Testes aprovados: ${passedTests}\n`;
                report += `‚ö†Ô∏è Testes com avisos: ${warningTests}\n`;
                report += `‚ùå Testes falharam: ${failedTests}\n`;
                report += `üìä Total de testes: ${totalTests}\n`;
                report += `\n`;
                report += `DETALHES:\n`;

                Object.entries(this.results).forEach(([testId, result]) => {
                    const testName = document.getElementById(testId).querySelector('strong').textContent;
                    report += `${testName} ${result.message}\n`;
                });

                report += `\n`;
                report += `RECOMENDA√á√ïES:\n`;
                if (failedTests > 0) {
                    report += `- Verificar configura√ß√µes b√°sicas\n`;
                    report += `- Conferir chaves de API\n`;
                    report += `- Validar conex√£o com internet\n`;
                }
                if (warningTests > 0) {
                    report += `- Configurar chave do Azure Maps\n`;
                    report += `- Atualizar coordenadas com valores reais\n`;
                }

                detailedReport.textContent = report;
            }
        }

        // Executar testes ao carregar a p√°gina
        document.addEventListener('DOMContentLoaded', async () => {
            const tester = new SystemTester();
            await tester.runAllTests();

            // Event listeners para testes funcionais
            document.getElementById('test-qr-generation').addEventListener('click', () => {
                // Simular teste de QR Code
                document.getElementById('test-data-encoding').querySelector('.status').textContent = '‚úÖ Funcionando';
            });

            document.getElementById('rerun-tests').addEventListener('click', () => {
                location.reload();
            });

            document.getElementById('download-report').addEventListener('click', () => {
                const report = document.getElementById('detailed-report').textContent;
                const blob = new Blob([report], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `relatorio-sistema-${new Date().toISOString().split('T')[0]}.txt`;
                a.click();
                URL.revokeObjectURL(url);
            });
        });
    </script>
</body>
</html>