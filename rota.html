<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rota GPS - Sistema de Navega√ß√£o</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.css" type="text/css">
    <style>
        .loading { display: none; }
        .error { display: none; }
        .route-info { display: none; }
        #map { height: 400px; width: 100%; }
        .status-indicator { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-success { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- Loading Section -->
        <div class="loading text-center" id="loadingSection">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <h3 class="mt-3">üöõ Carregando sua Rota</h3>
            <p>Processando dados...</p>
        </div>

        <!-- Error Section -->
        <div class="error text-center" id="errorSection">
            <h3>‚ö†Ô∏è Erro de Acesso</h3>
            <h4>Link Inv√°lido ou Expirado</h4>
            <p>Este QR Code pode ter expirado ou os dados est√£o corrompidos.</p>
            <button class="btn btn-primary" onclick="retryLoad()">üîÑ Tentar Novamente</button>
            <button class="btn btn-secondary" onclick="goBack()">‚Üê Voltar</button>
        </div>

        <!-- Route Info Section -->
        <div class="route-info" id="routeSection">
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>Informa√ß√µes da Rota</h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Motorista:</strong> <span id="driverName">-</span></p>
                            <p><strong>Placa:</strong> <span id="truckPlate">-</span></p>
                            <p><strong>Destino:</strong> <span id="destination">-</span></p>
                            <p><strong>‚è∞ Expira em:</strong> <span id="expiryTime">--:--:--</span></p>
                        </div>
                    </div>
                    
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5>üìç Informa√ß√µes de Navega√ß√£o</h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Dist√¢ncia Total:</strong> <span id="totalDistance">Calculando...</span></p>
                            <p><strong>Tempo Estimado:</strong> <span id="estimatedTime">Calculando...</span></p>
                            <div id="instructions">Carregando instru√ß√µes...</div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>Mapa de Navega√ß√£o</h5>
                        </div>
                        <div class="card-body p-0">
                            <div id="map"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.js"></script>
    <script src="config.js"></script>
    
    <script>
        let map = null;
        let routeData = null;
        let expiryInterval = null;

        // Fun√ß√£o para decodificar dados do QR Code
        function decodeRouteData() {
            const urlParams = new URLSearchParams(window.location.search);
            const encodedData = urlParams.get('data');
            
            if (!encodedData) {
                throw new Error('Dados n√£o encontrados na URL');
            }
            
            try {
                const decodedData = atob(encodedData);
                return JSON.parse(decodedData);
            } catch (error) {
                throw new Error('Erro ao decodificar dados: ' + error.message);
            }
        }

        // Fun√ß√£o para verificar se o link expirou
        function isExpired(data) {
            const now = Date.now();
            return now > data.expiryDate;
        }

        // Fun√ß√£o para mostrar se√ß√£o
        function showSection(sectionId) {
            document.querySelectorAll('.loading, .error, .route-info').forEach(el => {
                el.style.display = 'none';
            });
            document.getElementById(sectionId).style.display = 'block';
        }

        // Fun√ß√£o para popular informa√ß√µes
        function populateRouteInfo(data) {
            document.getElementById('driverName').textContent = data.driverName || '-';
            document.getElementById('truckPlate').textContent = data.truckPlate || '-';
            
            const dock = CONFIG.destinationDocks[data.destinationDockId];
            document.getElementById('destination').textContent = dock ? dock.name : 'Doca n√£o encontrada';
            
            // Iniciar contador de expira√ß√£o
            startExpiryTimer(data.expiryDate);
        }

        // Fun√ß√£o para iniciar timer de expira√ß√£o
        function startExpiryTimer(expiryDate) {
            if (expiryInterval) clearInterval(expiryInterval);
            
            expiryInterval = setInterval(() => {
                const now = Date.now();
                const timeLeft = expiryDate - now;
                
                if (timeLeft <= 0) {
                    clearInterval(expiryInterval);
                    document.getElementById('expiryTime').textContent = 'EXPIRADO';
                    return;
                }
                
                const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                
                document.getElementById('expiryTime').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // Fun√ß√£o para inicializar o mapa
        function initializeMap(data) {
            const entryGate = CONFIG.entryGates[data.entryGateId];
            const destinationDock = CONFIG.destinationDocks[data.destinationDockId];
            
            if (!entryGate || !destinationDock) {
                throw new Error('Portaria ou doca n√£o encontrada na configura√ß√£o');
            }

            // Usar coordenadas padr√£o se Azure Maps n√£o estiver configurado
            const useAzureMaps = CONFIG.azureMapsKey && CONFIG.azureMapsKey !== 'SUA_CHAVE_AZURE_MAPS_AQUI';
            
            if (useAzureMaps) {
                // Inicializar Azure Maps
                map = new atlas.Map('map', {
                    center: [entryGate.coordinates.lng, entryGate.coordinates.lat],
                    zoom: 15,
                    language: 'pt-BR',
                    authOptions: {
                        authType: 'subscriptionKey',
                        subscriptionKey: CONFIG.azureMapsKey
                    }
                });

                map.events.add('ready', function () {
                    // Adicionar marcadores
                    const datasource = new atlas.source.DataSource();
                    map.sources.add(datasource);

                    // Marcador de origem
                    datasource.add(new atlas.data.Feature(new atlas.data.Point([entryGate.coordinates.lng, entryGate.coordinates.lat]), {
                        title: 'Origem: ' + entryGate.name,
                        icon: 'pin-blue'
                    }));

                    // Marcador de destino
                    datasource.add(new atlas.data.Feature(new atlas.data.Point([destinationDock.coordinates.lng, destinationDock.coordinates.lat]), {
                        title: 'Destino: ' + destinationDock.name,
                        icon: 'pin-red'
                    }));

                    // Adicionar camada de s√≠mbolos
                    map.layers.add(new atlas.layer.SymbolLayer(datasource, null, {
                        iconOptions: {
                            allowOverlap: true
                        },
                        textOptions: {
                            textField: ['get', 'title'],
                            offset: [0, -2]
                        }
                    }));

                    // Calcular rota
                    calculateRoute(entryGate.coordinates, destinationDock.coordinates);
                });
            } else {
                // Fallback para mapa simples sem Azure Maps
                initializeSimpleMap(entryGate, destinationDock);
            }
        }

        // Fun√ß√£o para mapa simples (fallback)
        function initializeSimpleMap(entryGate, destinationDock) {
            const mapElement = document.getElementById('map');
            mapElement.innerHTML = `
                <div class="p-3 text-center bg-light">
                    <h6>Rota Calculada</h6>
                    <p><strong>Origem:</strong> ${entryGate.name}</p>
                    <p><strong>Destino:</strong> ${destinationDock.name}</p>
                    <p><small>Coordenadas: ${entryGate.coordinates.lat}, ${entryGate.coordinates.lng} ‚Üí ${destinationDock.coordinates.lat}, ${destinationDock.coordinates.lng}</small></p>
                    <div class="alert alert-info mt-3">
                        <small>Para visualizar o mapa completo, configure sua chave do Azure Maps no arquivo config.js</small>
                    </div>
                </div>
            `;
            
            // Simular c√°lculo de rota
            const distance = calculateDistance(entryGate.coordinates, destinationDock.coordinates);
            document.getElementById('totalDistance').textContent = distance.toFixed(2) + ' km';
            document.getElementById('estimatedTime').textContent = Math.ceil(distance / 20) + ' minutos';
            document.getElementById('instructions').innerHTML = `
                <ol>
                    <li>Siga em dire√ß√£o ao ${destinationDock.name}</li>
                    <li>Mantenha-se na via principal</li>
                    <li>Chegue ao destino</li>
                </ol>
            `;
        }

        // Fun√ß√£o para calcular dist√¢ncia entre dois pontos
        function calculateDistance(coord1, coord2) {
            const R = 6371; // Raio da Terra em km
            const dLat = (coord2.lat - coord1.lat) * Math.PI / 180;
            const dLon = (coord2.lng - coord1.lng) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(coord1.lat * Math.PI / 180) * Math.cos(coord2.lat * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Fun√ß√£o para calcular rota (Azure Maps)
        function calculateRoute(origin, destination) {
            const url = `https://atlas.microsoft.com/route/directions/json?subscription-key=${CONFIG.azureMapsKey}&api-version=1.0&query=${origin.lat},${origin.lng}:${destination.lat},${destination.lng}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.routes && data.routes.length > 0) {
                        const route = data.routes[0];
                        const summary = route.summary;
                        
                        document.getElementById('totalDistance').textContent = (summary.lengthInMeters / 1000).toFixed(2) + ' km';
                        document.getElementById('estimatedTime').textContent = Math.ceil(summary.travelTimeInSeconds / 60) + ' minutos';
                        
                        // Adicionar linha da rota ao mapa
                        const routeCoordinates = route.legs[0].points.map(point => [point.longitude, point.latitude]);
                        const routeDataSource = new atlas.source.DataSource();
                        map.sources.add(routeDataSource);
                        routeDataSource.add(new atlas.data.Feature(new atlas.data.LineString(routeCoordinates)));
                        
                        map.layers.add(new atlas.layer.LineLayer(routeDataSource, null, {
                            strokeColor: '#2272B9',
                            strokeWidth: 5,
                            lineJoin: 'round',
                            lineCap: 'round'
                        }));
                        
                        // Ajustar visualiza√ß√£o para mostrar toda a rota
                        map.setCamera({
                            bounds: atlas.data.BoundingBox.fromData(new atlas.data.LineString(routeCoordinates)),
                            padding: 50
                        });
                    }
                })
                .catch(error => {
                    console.error('Erro ao calcular rota:', error);
                    document.getElementById('totalDistance').textContent = 'Erro no c√°lculo';
                    document.getElementById('estimatedTime').textContent = 'Erro no c√°lculo';
                });
        }

        // Fun√ß√£o para tentar carregar novamente
        function retryLoad() {
            location.reload();
        }

        // Fun√ß√£o para voltar
        function goBack() {
            window.history.back();
        }

        // Inicializa√ß√£o principal
        document.addEventListener('DOMContentLoaded', function() {
            showSection('loadingSection');
            
            try {
                routeData = decodeRouteData();
                
                if (isExpired(routeData)) {
                    showSection('errorSection');
                    return;
                }
                
                populateRouteInfo(routeData);
                initializeMap(routeData);
                showSection('routeSection');
                
            } catch (error) {
                console.error('Erro ao carregar rota:', error);
                showSection('errorSection');
            }
        });
    </script>
</body>
</html>
